<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="bg-white shadow-xl rounded-lg">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-gray-200">
      <h1 class="text-2xl font-bold text-gray-900">New Analysis Request</h1>
      <p class="mt-1 text-sm text-gray-500">Ask a question about your data in plain English</p>
    </div>
    
    <!-- Form -->
    <%= form_with model: @analysis_request, local: false, data: { turbo: true }, class: "px-6 py-4" do |f| %>
      <% if @analysis_request.errors.any? %>
        <div class="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
          <h3 class="font-medium">Please fix the following errors:</h3>
          <ul class="mt-2 list-disc list-inside text-sm">
            <% @analysis_request.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <!-- Natural Language Query -->
      <div class="mb-6">
        <%= f.label :natural_language_query, "Your Question", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= f.text_area :natural_language_query,
            rows: 4,
            placeholder: "e.g., 'Show me the monthly sales trend for the last year' or 'Which customers have the highest lifetime value?'",
            class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md",
            data: { 
              controller: "autosize",
              action: "input->autosize#resize"
            } %>
        <p class="mt-2 text-sm text-gray-500">
          Be specific about what you want to analyze. Our AI will understand and generate the appropriate code.
        </p>
      </div>
      
      <!-- Dataset Selection -->
      <div class="mb-6">
        <%= f.label :dataset_id, "Dataset", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= f.select :dataset_id,
            options_for_select(
              @datasets.map { |d| 
                [
                  "#{d.name} (#{d.source_type.humanize})",
                  d.id,
                  { 
                    'data-source-type' => d.source_type,
                    'data-status' => d.status
                  }
                ]
              }
            ),
            { prompt: "Select a dataset..." },
            class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md",
            data: {
              controller: "dataset-selector",
              action: "change->dataset-selector#showDatasetInfo"
            } %>
        
        <!-- Dataset Info (shown dynamically) -->
        <div id="dataset-info" class="mt-3 hidden">
          <div class="bg-gray-50 rounded-md p-3">
            <div class="flex items-center">
              <svg class="h-5 w-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
              </svg>
              <div class="text-sm">
                <span class="font-medium text-gray-700">Status:</span>
                <span id="dataset-status" class="ml-1"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Analysis Type -->
      <div class="mb-6">
        <%= f.label :analysis_type, "Analysis Type", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <div class="space-y-2">
          <% ['exploratory', 'statistical', 'predictive', 'descriptive', 'diagnostic'].each do |type| %>
            <label class="flex items-start">
              <%= f.radio_button :analysis_type, type, 
                  class: "mt-1 focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" %>
              <div class="ml-3">
                <span class="block text-sm font-medium text-gray-700">
                  <%= type.capitalize %> Analysis
                </span>
                <span class="block text-sm text-gray-500">
                  <% case type %>
                  <% when 'exploratory' %>
                    Discover patterns and insights in your data
                  <% when 'statistical' %>
                    Statistical tests and significance analysis
                  <% when 'predictive' %>
                    Build models to predict future outcomes
                  <% when 'descriptive' %>
                    Summarize and describe your data
                  <% when 'diagnostic' %>
                    Understand why something happened
                  <% end %>
                </span>
              </div>
            </label>
          <% end %>
        </div>
      </div>
      
      <!-- Priority -->
      <div class="mb-6">
        <%= f.label :priority, class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= f.select :priority,
            options_for_select([
              ['Low - Can wait', 'low'],
              ['Normal - Standard processing', 'normal'],
              ['High - Process quickly', 'high']
            ], 'normal'),
            {},
            class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" %>
      </div>
      
      <!-- Examples Section -->
      <div class="mb-6 bg-blue-50 rounded-lg p-4">
        <h3 class="text-sm font-medium text-blue-900 mb-2">Example Questions You Can Ask:</h3>
        <ul class="text-sm text-blue-700 space-y-1">
          <li>• "What are the top 10 products by revenue last quarter?"</li>
          <li>• "Show me customer churn rate trends over the past year"</li>
          <li>• "Build a predictive model for customer lifetime value"</li>
          <li>• "Find correlations between marketing spend and sales"</li>
          <li>• "Identify seasonal patterns in our sales data"</li>
        </ul>
      </div>
      
      <!-- Submit Buttons -->
      <div class="flex justify-end space-x-3">
        <%= link_to "Cancel", analysis_requests_path, 
            class: "px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
        
        <%= f.submit "Start Analysis", 
            class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",
            data: { 
              disable_with: "Starting analysis...",
              turbo_confirm: "Ready to start the analysis?"
            } %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Stimulus controller for dataset selector
  import { Controller } from "@hotwired/stimulus"
  
  export default class extends Controller {
    showDatasetInfo(event) {
      const select = event.target
      const selectedOption = select.options[select.selectedIndex]
      
      if (selectedOption.value) {
        const info = document.getElementById('dataset-info')
        const status = document.getElementById('dataset-status')
        
        info.classList.remove('hidden')
        status.textContent = selectedOption.dataset.status
        status.className = `ml-1 inline-flex px-2 text-xs font-semibold rounded-full ${
          selectedOption.dataset.status === 'connected' 
            ? 'bg-green-100 text-green-800'
            : 'bg-yellow-100 text-yellow-800'
        }`
      }
    }
  }
</script>